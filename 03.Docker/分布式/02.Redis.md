# Redis

### Base Command

```perl6
#查看所有Key 
keys *
#获取key值
get key
#添加值
set key
```

### Linux

#### Centos 7

```perl

```

#### Docker

##### 1. 配置环境

```perl
192.168.137.129 Redis-Master 6379 |{Sentinel01} 26379
192.168.137.129 Redis-Slave 6380  |{Sentinel02} 26380
192.168.137.129 Redis-Slave 6381  |{Sentinel03} 26381 

|/root/Zhong/docker/redis
├── redis-config
│   ├── redis-6379.conf
│   ├── redis-6380.conf
│   └── redis-6381.conf
├── redis-data-6379
├── redis-data-6380
├── redis-data-6381
├── sentinel-config
│   ├── sentinel-26379.conf
│   ├── sentinel-26380.conf
│   └── sentinel-26381.conf
├── sentinel-data-26379
├── sentinel-data-26380
└── sentinel-data-26381
```

##### 2. Redis主从复制

```perl
#1.拉取镜像
docker pull redis:latest

#下载redis.conf文件
wget http://download.redis.io/redis-stable/redis.conf

#2.启动容器
#第一种单独部署主从
docker run -p 6379:6379 --name redis-6379 \
-v /root/Zhong/docker/redis/redis-config/redis-6379.conf:/etc/redis/redis.conf \
-v /root/Zhong/docker/redis/redis-data-6379:/data \
-d redis redis-server /etc/redis/redis.conf \
--appendonly yes

docker run -p 6380:6379 --name redis-6380 \
-v /root/Zhong/docker/redis/redis-config/redis-6380.conf:/etc/redis/redis.conf \
-v /root/Zhong/docker/redis/redis-data-6380:/data \
-d redis redis-server /etc/redis/redis.conf \
--appendonly yes

docker run -p 6381:6379 --name redis-6381 \
-v /root/Zhong/docker/redis/redis-config/redis-6381.conf:/etc/redis/redis.conf \
-v /root/Zhong/docker/redis/redis-data-6381:/data \
-d redis redis-server /etc/redis/redis.conf \
--appendonly yes	

#第二种 兼容哨兵模式
docker run -p 6379:6379 -p 26379:26379 --name redis-master \
-v /data/docker_data/redis/conf/redis.conf:/etc/redis/redis.conf \
-v /data/docker_data/redis/data:/data \
-v /data/docker_data/redis/log/redis_master.log:/log/redis.log \
-v /data/docker_data/redis/conf/sentinel_master.conf:/etc/redis/sentinel.conf \
-d redis redis-server /redis/conf/redis.conf

docker exec -it redis-master /bin/bash -c 'redis-sentinel /redis/conf/sentinel.conf'

#3.进入容器
docker exec -it redis-6379 /bin/bash
docker exec -it redis-6380 /bin/bash
docker exec -it redis-6381 /bin/bash

#4.连接
redis-cli
redis-cli -a 123456
redis-cli -h 192.168.137.129 -p 6379 -a 123456
redis-cli -h 192.168.137.129 -p 6380 -a 123456
redis-cli -h 192.168.137.129 -p 6381 -a 123456

#查看内网的IP地址
docker inspect <container ID>
master - 172.17.0.2
slave-01 - 172.17.0.3
slave-02 - 172.17.0.4
#查看当前redis角色
info Replication
#设置主从角色(进入Redis从节点)
SLAVEOF 172.17.0.2 6379
```

##### 3. Redis哨兵模式

```perl
#1.修改配置文件
sentinel monitor mymaster 192.168.43.188 6379 2
sentinel auth-pass mymaster 123456

#2.启动容器
docker run -p 26379:26379 --name sentinel-26379 \
-v /root/Zhong/docker/redis/sentinel-config/sentinel-26379.conf:/etc/redis/sentinel.conf \
-v /root/Zhong/docker/redis/sentinel-data-26379:/data \
-d redis redis-sentinel /etc/redis/sentinel.conf	

docker run -p 26380:26379 --name sentinel-26380 \
-v /root/Zhong/docker/redis/sentinel-config/sentinel-26380.conf:/etc/redis/sentinel.conf \
-v /root/Zhong/docker/redis/sentinel-data-26380:/data \
-d redis redis-sentinel /etc/redis/sentinel.conf	

docker run -p 26381:26379 --name sentinel-26381 \
-v /root/Zhong/docker/redis/sentinel-config/sentinel-26381.conf:/etc/redis/sentinel.conf \
-v /root/Zhong/docker/redis/sentinel-data-26381:/data \
-d redis redis-sentinel /etc/redis/sentinel.conf
#3.进入容器
docker exec -it sentinel-26379 /bin/bash
docker exec -it sentinel-26380 /bin/bash
docker exec -it sentinel-26381 /bin/bash
#连接
redis-cli -p 26379
#查看哨兵信息
info sentinel
#查看Matser节点
sentinel master mymaster
```

**sentinel.conf**

```perl
port 26379
daemonize yes
protected-mode no
pidfile "/var/run/redis-sentinel.pid"
logfile "/var/log/redis-sentinel.log"                     
dir "/tmp"                    #工作目录
sentinel monitor mymaster 192.168.100.161 6379 2 
#sentinel monitor <master-name> <ip> <port> <quorum> 
#mymaster是集群的名称，master-name：监控的名字（任意）；
#ip port：master节点的ip和端口，不需要配置从节点信息；quorum：代表要判定主节点最终不可达所需要的票数
#2为法定人数限制（quorum），即有几个sentinel认为master down了就进行故障转移，一般此值是所有sentinel节点（一般总数是>=3的奇数，如3.5.7等）的一半以上的整数值，总数是3，即3/2=1.5，取值为2，是master的ODOWN客观下线的依据。

sentinel auth-pass mymaster password
##mymaster集群中master的密码，注意此行要在上面行的下面

sentinel down-after-milliseconds mymaster 5000  
#sentinel down-after-milliseconds <master-name> <times>：
# （每个Sentinel节点都要通过定期发送ping命令来判断Redis数据节点和其余Sentinel节点是否可达，如果超过了down-after-milliseconds配置的时间且没有有效的回复，则判定节点不可达，<times>（单位为毫秒）1秒=1000毫秒。

acllog-max-len 128
#ACL日志跟踪失败的命令和与ACL关联的身份验证事件, 在下面定义ACL日志的最大条目长度。
sentinel parallel-syncs mymaster 1
#sentinel parallel-syncs <master-name> <nums>
#发生故障转移后，可以同时向新master同步数据的slave的数量，数字越小总同步时间越长，但可以减轻新master的负载压力。

sentinel failover-timeout mymaster 50000  
#sentinel failover-timeout <master-name> <times>：
# 故障转移的超时时间

sentinel deny-scripts-reconfig yes
#禁止修改脚本

sentinel notification-script <master-name> <script-path>：
#在故障转移期间，当一些警告级别的Sentinel事件发生（指重要事件，例如-sdown：客观下线、-odown：主观下线）时，会触发对应路径的脚本，并向脚本发送相应的事件参数

sentinel client-reconfig-script <master-name> <script-path>：
#在故障转移结束后，会触发对应路径的脚本，并向脚本发送故障转移结果的相关参数。和notification-script类似
# HOSTNAMES SUPPORT

SENTINEL resolve-hostnames no
# 通过启用解析主机名来启用主机名支持。请注意，您必须确保DNS配置正确，并且DNS解析不会引入很长的延迟。

SENTINEL announce-hostnames no 
# 启用“解析主机名”时，Sentinel在向用户、配置文件等公开实例时仍使用IP地址。如果要在宣布时保留主机名，请启用下面的“宣布主机名”。
--------------------------------------------------------------------------------------------------------------------------------------------------------------------
不常用的配置
# SCRIPTS EXECUTION
sentinel notification-script mymaster /var/redis/notify.sh
# sentinel通知脚本和sentinel reconfig脚本用于配置在故障转移后被调用以通知系统管理员或重新配置客户端的脚本。使用以下错误处理规则执行脚本：
# 如果脚本以“1”退出，则稍后将重试执行（最大次数当前设置为10）。
# 如果脚本以“2”（或更高的值）退出，则不会重试脚本执行。
# 如果脚本因接收到信号而终止，则行为与退出代码1相同。
# 脚本的最大运行时间为60秒。达到此限制后，脚本将以SIGKILL终止，并重试执行。

# NOTIFICATION SCRIPT | 通知执行
# 为警告级别（例如-sdown、-odown等）中生成的任何sentinel事件调用指定的通知脚本
# Example:
# sentinel notification-script <master-name> <script-path>

 sentinel client-reconfig-script mymaster /var/redis/reconfig.sh 
# CLIENTS RECONFIGURATION SCRIPT | 客户端重新配置脚本（可以多次调用）
# 由于故障切换而更改主机时，可以调用脚本来执行特定于应用程序的任务，以通知客户端配置已更改且主机位于不同的地址。
# ip、from port、to ip、to port 的参数用于传递主机的旧地址和所选副本（现在是主机）的新地址。
# The following arguments are passed to the script:
# <master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port>
# <state> is currently always "failover"
# <role> is either "leader" or "observer"
# Example:
# sentinel client-reconfig-script <master-name> <script-path>

--------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Generated by CONFIG REWRITE Sentinel 以下的配置都是动态写进去的配置

protected-mode no
user default on nopass sanitize-payload ~* &* +@all
sentinel myid ab45d4d4b7484cbc231f96f3b8f1f502950a7627
sentinel leader-epoch mymaster 0
sentinel current-epoch 1
# 配置密码
sentinel auth-pass mymaster password
sentinel config-epoch mymaster 3
sentinel leader-epoch mymaster 0

# 发现了两个slave节点
sentinel known-replica mymaster 192.168.100.163 6379
sentinel known-replica mymaster 192.168.100.162 6379

# 发现了两个Sentinel节点
sentinel known-sentinel mymaster 192.168.100.163 26379 0d004b8d55fa5af749bf4114211274c51e65493a
sentinel known-sentinel mymaster 192.168.100.162 26379 f2b4e02c2d08b328b4f1ba89cb6a72be76822c9b

```



### Windows

```c#

```





